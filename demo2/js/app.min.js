

function trim1(a){return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}

function getMonthString(a){var b;switch(a){case 0:b="Jan";break;case 1:b="Feb";break;case 2:b="Mar";break;case 3:b="Apr";break;case 4:b="May";break;case 5:b="Jun";break;case 6:b="Jul";break;case 7:b="Aug";break;case 8:b="Sep";break;case 9:b="Oct";break;case 10:b="Nov";break;case 11:b="Dec";break;default:console.log("Error: Unknown month: "+b)}return b}

function getSelectedRow(a,b){for(var c=getMonthString(b.getMonth())+" "+b.getFullYear(),d=0;d<a.length;d++)if(a[d].month==c)return d;return-1}

function getSelectedPeriod(a,b){var c=getSelectedRow(aaiiData,a),d=getSelectedRow(aaiiData,b)+1;return aaiiData.slice(c,d)}

function initCategoryChart(a,b){var c=.8*chartDivWidth/b;selectedCategory="";var d=d3.select("#categories-chart").append("svg").attr("height",50),e=0;d.selectAll("rect").data(a).enter().append("rect").attr("category",
	
function(a){return a.key}).attr("x",

function(a){var d=e,f=Math.floor(c*a.value);return e+=f,d}).attr("y",7).attr("width",

function(a){var d=Math.floor(c*a.value);return d}).attr("height",25).style("fill",

function(a){return""!=a?""===selectedCategory||selectedCategory===a.key?d3.rgb(categoryColor[a.key]):d3.rgb(categoryColor[a.key]).darker(1.75):void 0}).on("click",

function(a){selectedCategory=a.key,d3.select("#categories-chart").select(".reset").style("display",null),screenCategory.filter(selectedCategory).top(b),updateCategoryChart(screenCategory,b),dc.renderAll()}).on("mouseover",

function(){d3.select(this).style("cursor","pointer")}),$("rect").popover({container:"body",trigger:"hover",placement:"top",content:

function(){return d3.select(this).attr("category")}})}

function updateCategoryChart(a,b){var c=.8*chartDivWidth/b,d=0,e=d3.select("#categories-chart");e.selectAll("rect").data(a).transition().duration(150).attr("x",
	
function(a){var b=d,e=Math.floor(c*a.value);return d+=e,b}).attr("y",7).attr("width",

function(a){var b=Math.floor(c*a.value);return b}).attr("height",25).attr("category",

function(a){return a.key}).style("fill",

function(a){return""!=a?""===selectedCategory||selectedCategory===a.key?d3.rgb(categoryColor[a.key]):d3.rgb(categoryColor[a.key]).darker(1.75):void 0}),$("rect").popover({container:"body",trigger:"hover",placement:"top",content:

function(){return d3.select(this).attr("category")}})}

function createCrossFilters(a){var b=crossfilter(a),c=b.groupAll();annualizedReturn=b.dimension(
	
	function(a){return Math.ceil(a.annualizedReturn)});var d=annualizedReturn.group();sharpeRatio=b.dimension(

function(a){return parseFloat(a.sharpeRatio)});var e=sharpeRatio.group(

function(a){return Math.ceil(100*a)/100});stdDev=b.dimension(

function(a){return Math.ceil(parseFloat(a.stdDev))});var f=stdDev.group();screenCategory=b.dimension(

function(a){return""!=a.screenType?a.screenType:void 0});var g=screenCategory.group();riskIdx=b.dimension(

function(a){return parseFloat(a.riskIdx)});var h=riskIdx.group(),i=9999;turnover=b.dimension(

function(a){return isNaN(parseFloat(a.turnover))?i++:Math.ceil(parseFloat(a.turnover))});var j=turnover.group(),k=170,l=.15*chartDivWidth;159>l&&(l=159);var m={top:10,right:20,bottom:40,left:20},n=d3.extent(a,

function(a){return parseFloat(a.sharpeRatio)});t=.05,sharpeRatioChart.width(l).height(k).margins(m).dimension(sharpeRatio).group(e).transitionDuration(350).centerBar(!0).gap(1).round(dc.round.floor).x(d3.scale.linear().domain([n[0]-t,n[1]+t])).xUnits(dc.units.float.precision(.01)).renderHorizontalGridLines(!0).xAxis().ticks(4);var o=d3.extent(a,

function(a){return Math.ceil(parseFloat(a.stdDev))});t=(o[1]-o[0])/20,stdDevChart.width(l).height(k).margins(m).dimension(stdDev).group(f).transitionDuration(350).centerBar(!0).gap(1).round(dc.round.floor).x(d3.scale.linear().domain([o[0]-t,o[1]+t])).xUnits(

function(){return 30}).renderHorizontalGridLines(!0).xAxis().ticks(4).tickFormat(

function(a){return a+"%"});var p=d3.extent(a,

function(a){return parseFloat(a.riskIdx)});t=.1,riskIdxChart.width(l).height(k).margins(m).dimension(riskIdx).group(h).transitionDuration(350).centerBar(!0).gap(5).x(d3.scale.linear().domain([p[0]-t,p[1]+t])).xUnits(dc.units.float.precision(.1)).renderHorizontalGridLines(!0).xAxis().ticks(4);var q=d3.extent(a,

function(a){return Math.ceil(parseFloat(a.turnover))});t=(q[1]-q[0])/20,turnoverChart.width(l).height(k).margins(m).dimension(turnover).group(j).centerBar(!0).gap(5).round(dc.round.floor).x(d3.scale.linear().domain([q[0]-t,q[1]+t])).xUnits(

function(){return 30}).renderHorizontalGridLines(!0).xAxis().ticks(4).tickFormat(

function(a){return a+"%"});var r=d3.extent(a,

function(a){return Math.ceil(a.annualizedReturn)});d3.scale.quantize().domain([r[0],r[1]]);var t=(r[1]-r[0])/20;initialized?returnsChart.width(l).height(k).margins(m).dimension(annualizedReturn).group(d).transitionDuration(350).centerBar(!0).gap(1).round(dc.round.floor).x(d3.scale.linear().domain([r[0]-t,r[1]+t])).renderHorizontalGridLines(!0).xAxis().ticks(5).tickFormat(

function(a){return a+"%"}):returnsChart.width(l).height(k).margins(m).dimension(annualizedReturn).group(d).transitionDuration(350).centerBar(!0).gap(1).round(dc.round.floor).x(d3.scale.linear().domain([r[0]-t,r[1]+t])).filter([5,25]).renderHorizontalGridLines(!0).xAxis().ticks(5).tickFormat(

function(a){return a+"%"}),dc.dataCount(".dc-data-count").dimension(b).group(c),dc.renderAll(),riskIdxChart.renderlet(

function(){initialized?(updateCategoryChart(g.all(),a.length),"Annualized Return"===sortBy?updateTables(annualizedReturn.top(a.length)):"Sharpe Ratio"===sortBy?updateTables(sharpeRatio.top(a.length)):"Std Deviation"===sortBy?updateTables(stdDev.top(a.length)):"Risk Index"===sortBy?updateTables(riskIdx.top(a.length)):"Average Turnover"===sortBy&&updateTables(turnover.top(a.length))):(initCategoryChart(g.all(),a.length),displayStatsTable(annualizedReturn.top(a.length)),initialized=!0)}),window.onresize=

function(){window.innerWidth,updateCategoryChart(g.all(),a.length)}}

function calcAnnualizedReturn(a){for(var b=1,c=a.length,d=0;c>d;d++)b*=(parseFloat(a[d])/100+1).toFixed(2);var e=100*(Math.pow(b,12/c)-1);return(showingCummulative||!initialized)&&(document.getElementById("returnsLabel").innerHTML='<span>Annualized Return </span><a class="reset" href="javascript:returnsChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>',showingCummulative=!1),e.toFixed(2)}

function calcCummulativeReturn(a){for(var b=1,c=0;c<a.length;c++)b*=(parseFloat(a[c])/100+1).toFixed(2);var d=100*(b-1);return showingCummulative||(document.getElementById("returnsLabel").innerHTML='<span>Cummulative Return </span><a class="reset" href="javascript:returnsChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>',showingCummulative=!0),d.toFixed(2)}

function calcStdDev(a){var b=new ps.array(a);return b.stdDev().toFixed(2)}

function calcRiskIndex(a,b){return(a/b).toFixed(2)}

function calcAveExcess(a,b){for(var c=a.length,d=0,e=0;c>e;e++)d+=a[e]-b[e];return 1*d/c}

function calcStdDevExcess(a,b,c){for(var d=a.length,e=0,f=0;d>f;f++)e+=Math.pow(a[f]-b[f]-c,2);return Math.sqrt(1*e/(d-1))}

function calcSharpeRatio(a,b){var c=calcAveExcess(a,b),d=calcStdDevExcess(a,b,c);return(c/d).toFixed(2)}

function calculateStats(a,b){var c=getSelectedPeriod(a,b,aaiiData),d=[];for(var e in c[0])if(c[0].hasOwnProperty(e)&&"month"!=e){for(var f=[],g=0;g<c.length;g++)f.push(parseFloat(c[g][e]));d[e]=f}var h,i=[],j=[],k="S&P 500 price chg";h=c.length>=12?calcAnnualizedReturn(d[k]):calcCummulativeReturn(d[k]);var l=calcSharpeRatio(d[k],d["T-Bills price chg"]),m=calcStdDev(d[k]),n=parseFloat(getTurnover(k));j.push({screen:k.replace("price chg","")}),j.push({screenType:getScreenType(k)}),j.push({annualizedReturn:h}),j.push({stdDev:m}),j.push({riskIdx:1..toFixed(2)}),j.push({sharpeRatio:l}),j.push({turnover:n}),i.push({screen:k,screenType:getScreenType(k),annualizedReturn:h,stdDev:m,riskIdx:1..toFixed(2),sharpeRatio:l,turnover:n,stats:j});for(var e in c[0])if(c[0].hasOwnProperty(e)&&"month"!==e&&e!==k){h=c.length>=12?calcAnnualizedReturn(d[e]):calcCummulativeReturn(d[e]),l="T-Bills price chg"==e?0:calcSharpeRatio(d[e],d["T-Bills price chg"]);var o=calcStdDev(d[e]);n=parseFloat(getTurnover(e)),j=[],j.push({screen:e.replace("price chg","")}),j.push({screenType:getScreenType(e)}),j.push({annualizedReturn:h}),j.push({stdDev:o}),j.push({riskIdx:calcRiskIndex(o,m)}),j.push({sharpeRatio:l}),j.push({turnover:n}),i.push({screen:e,screenType:getScreenType(e),annualizedReturn:h,stdDev:o,riskIdx:calcRiskIndex(o,m),sharpeRatio:l,turnover:n,stats:j})}createCrossFilters(i)}

function resetScreenCategory(){screenCategory.filterAll(),selectedCategory="",d3.select("#categories-chart").select(".reset").style("display","none")}

function resetFilters(){
	returnsChart.filterAll(),
	riskIdxChart.filterAll(),
	stdDevChart.filterAll(),
	sharpeRatioChart.filterAll(),
	turnoverChart.filterAll(),
	resetScreenCategory(),
	deleteTables()
}

function setTimeRange(a,b,c,d){
	initialized?(resetFilters(),
	updateTimeControls(a,b),
	calculateStats(a,b)):(
		calculateStats(c,d),
		initTimeControls(a,b,c,d)
	)
}

function initTimeControls(a,b,c,d){
	var e=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"];
	$("#time-range-selector").dateRangeSlider({
		bounds:{min:a,max:b},
		defaultValues:{min:c,max:d},
		range:{min:{months:1}},
		formatter:
			function(a){
				var b=e[a.getMonth()],
				c=a.getFullYear();return b+" "+c}
			}),
		$("#time-range-selector").dateRangeSlider({
			valueLabels:"show",
			arrows:!1,
			step:{months:1}
		}),
		$("#time-range-selector").bind("valuesChanged",
			function(a,b){
			resetFilters(),
			calculateStats(b.values.min,b.values.max)
	})
}


function updateTimeControls(a,b){
	$("#time-range-selector").dateRangeSlider("values",a,b)
}

function deleteTables(){
	var a=d3.select("body");
	a.select("#stats").remove()
}

function updateTables(a){deleteTables(),displayStatsTable(a)}

function displayStatsTable(a){var b="100px",c="50px",d=[];d.push("Strategy Name"),d.push("Category"),showingCummulative?d.push("Cummulative Return"):d.push("Annualized Return"),d.push("Std Deviation"),d.push("Risk Index"),d.push("Sharpe Ratio"),d.push("Average Turnover");var e=d3.select("#stats-table").style("overflow-y","scroll").append("table").style("class","table-bordered").style("table-layout","fixed").style("width","100%").style("border-collapse","collapse").style("border","1px black solid").attr("id","stats"),f=e.append("thead");f.append("tr").selectAll("th").data(d).enter().append("th").style("width",
	
	function(a,d){return 2>d?b:c}).style("border","1px #aaaaaa solid").style("padding","5px").text(

function(a){return a}).style("font-size","10px").style("color",

function(a,b){var c="#9003CD";return 2>b?"black":"Annualized Return"!==sortBy&&"Cummulative Return"!==sortBy||2!=b?"Std Deviation"===sortBy&&3==b?c:"Risk Index"===sortBy&&4==b?c:"Sharpe Ratio"===sortBy&&5==b?c:"Average Turnover"===sortBy&&6==b?c:"blue":c}).style("text-align","center").on("mouseover",

function(a,b){b>1&&d3.select(this).style("cursor","pointer")}).on("click",

function(a,b){b>1&&(sortBy=a),"Annualized Return"===sortBy||"Cummulative Return"===sortBy?updateTables(annualizedReturn.top(aaiiData.length)):"Sharpe Ratio"===sortBy?updateTables(sharpeRatio.top(aaiiData.length)):"Std Deviation"===sortBy?updateTables(stdDev.top(aaiiData.length)):"Risk Index"===sortBy?updateTables(riskIdx.top(aaiiData.length)):"Average Turnover"===sortBy&&updateTables(turnover.top(aaiiData.length))}),e.append("tbody").selectAll("tr").data(a).enter().append("tr").on("mouseover",

function(){d3.select(this).style("background-color","aliceblue")}).on("mouseout",

function(a){d3.select(this).style("background-color",d3.rgb(categoryColor[a.screenType]))}).style("background-color",

function(a){return d3.rgb(categoryColor[a.screenType])}).attr("screen",

function(a){return a.screen}).attr("screenType",

function(a){return a.screenType}).selectAll("td").data(

function(a){return a.stats}).enter().append("td").style("white-space","nowrap").style("overflow","hidden").style("border","1px #aaaaaa solid").style("padding","1px").style("width",

function(a,d){return 2>d?b:c}).text(

function(a,b){if(0==b)return a.screen;if(1==b)return a.screenType;if(2==b)return a.annualizedReturn;if(3==b)return a.stdDev;if(4==b)return a.riskIdx;if(5==b){var c=parseFloat(a.sharpeRatio);return c.toFixed(2)}return 6==b?a.turnover:void 0}).on("click",

function(a,b){var c=getScreenDetails(a.screen);0==b&&"undefined"!=typeof c&&window.open(c.url,"targetWindow")}).style("font-size","10px").style("color",

function(a,b){var c=d3.select(this.parentNode).attr("screen"),d=getScreenDetails(c);return 0==b&&"undefined"!=typeof d?"blue":"black"}).style("text-align",

function(a,b){return 2>b?"left":"center"}).on("mouseover",

function(a,b){var c=d3.select(this.parentNode).attr("screen"),d=getScreenDetails(c);0==b&&"undefined"!=typeof d&&d3.select(this).style("cursor","pointer")}),$("table tr td:nth-child(1)").popover({container:"body",trigger:"hover",placement:"top",html:!0,title:

function(){return d3.select(this.parentNode).attr("screen").replace("price chg","")},content:

function(){var a=d3.select(this.parentNode).attr("screen"),b=getScreenDetails(a);if("undefined"!=typeof b){var c=b.desc;return c}return""}})}